<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chroma 62000P Editor (Dark Mode)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/2.0.1/chartjs-plugin-zoom.min.js"></script>
    <style>
        /* ‚òÖ‚òÖ‚òÖ CSS Variables for Theming ‚òÖ‚òÖ‚òÖ */
        :root {
            --bg-body: #f4f4f9;
            --bg-sidebar: #ffffff;
            --bg-block: #ffffff;
            --bg-header-light: #e9ecef;
            --bg-input: #ffffff;
            --text-main: #333333;
            --text-muted: #666666;
            --border-color: #ddd;
            --chart-grid: #e5e5e5;
            --chart-text: #666;
        }

        /* Dark Mode Overrides */
        body.dark-mode {
            --bg-body: #121212;
            --bg-sidebar: #1e1e1e;
            --bg-block: #252525;
            --bg-header-light: #2c2c2c;
            --bg-input: #333333;
            --text-main: #e0e0e0;
            --text-muted: #aaaaaa;
            --border-color: #444;
            --chart-grid: #444;
            --chart-text: #aaa;
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 0; margin: 0; display: flex; height: 100vh; background-color: var(--bg-body); color: var(--text-main); transition: background-color 0.3s, color 0.3s; }
        
        /* Layout */
        .sidebar { width: 440px; background: var(--bg-sidebar); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; overflow: hidden; box-shadow: 2px 0 5px rgba(0,0,0,0.1); transition: background-color 0.3s; }
        .main-content { flex: 1; padding: 20px; display: flex; flex-direction: column; overflow: hidden; }
        
        .header { padding: 15px; background: #343a40; color: white; flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; }
        .header h2 { margin: 0; font-size: 1.2rem; }
        
        .controls { padding: 10px; border-bottom: 1px solid var(--border-color); background: var(--bg-header-light); display: flex; gap: 5px; flex-wrap: wrap; transition: background-color 0.3s; }
        .btn { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem; transition: 0.2s; font-weight: 500;}
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-dark { background: #343a40; color: white; border: 1px solid #555; } /* Theme Toggle */
        .btn-sm { padding: 2px 8px; font-size: 0.75rem; margin-left: 5px;}
        .btn:hover { opacity: 0.9; filter: brightness(110%); }

        /* Scrollable Editor */
        .editor-area { flex: 1; overflow-y: auto; padding: 10px; }
        
        .prog-block { border: 1px solid var(--border-color); border-radius: 5px; margin-bottom: 15px; background: var(--bg-block); overflow: hidden; position: relative; transition: background-color 0.3s; }
        .prog-header { background: var(--bg-header-light); padding: 8px 10px; display: flex; justify-content: space-between; align-items: center; font-weight: bold; font-size: 0.9rem; border-bottom: 1px solid var(--border-color); color: var(--text-main); }
        .prog-settings { padding: 10px; background: var(--bg-block); border-bottom: 1px solid var(--border-color); font-size: 0.85rem; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;}
        
        .seq-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; color: var(--text-main); }
        .seq-table th { text-align: left; background: var(--bg-header-light); padding: 5px; font-weight: 600; border-bottom: 1px solid var(--border-color); color: var(--text-main); }
        .seq-table td { padding: 4px 5px; border-bottom: 1px solid var(--border-color); }
        .seq-table input { width: 100%; box-sizing: border-box; padding: 3px; border: 1px solid var(--border-color); border-radius: 3px; background: var(--bg-input); color: var(--text-main); }
        .seq-table input:focus { border-color: #007bff; outline: none; }
        
        .add-seq-row { text-align: center; padding: 5px; background: var(--bg-header-light); border-top: 1px solid var(--border-color); }
        
        .chart-container { flex: 1; position: relative; background: var(--bg-block); border-radius: 8px; padding: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); min-height: 0; transition: background-color 0.3s; }
        
        label { font-size: 0.8rem; color: var(--text-muted); display: block; margin-bottom: 2px;}
        .file-input-wrapper { width: 100%; margin-bottom: 5px;}
        
        body.dark-mode input[type="file"] { color: var(--text-muted); }

        /* Modal Styles */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: var(--bg-block); color: var(--text-main); padding: 25px; border-radius: 8px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 5px 15px rgba(0,0,0,0.3); position: relative; border: 1px solid var(--border-color); }
        .modal-close { position: absolute; top: 15px; right: 20px; font-size: 1.5rem; cursor: pointer; color: var(--text-muted); }
        .modal-close:hover { color: var(--text-main); }
        .help-section h3 { border-bottom: 2px solid var(--border-color); padding-bottom: 10px; margin-top: 20px; color: #007bff; font-size: 1.1rem; }
        .help-section h3:first-child { margin-top: 0; }
        .help-section ul { padding-left: 20px; line-height: 1.6; font-size: 0.95rem; color: var(--text-main); }
        .help-key { font-weight: bold; color: var(--text-main); background: var(--bg-header-light); padding: 2px 5px; border-radius: 3px; font-family: monospace; border: 1px solid var(--border-color); }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="header">
            <h2>Chroma Editor</h2>
        </div>
        <div class="controls">
            <div class="file-input-wrapper">
                <input type="file" id="fileInput" accept=".csv,.txt" />
            </div>
            <button class="btn btn-primary" onclick="addNewProgram()">+ New Prog</button>
            <button class="btn btn-success" onclick="downloadCSV()">üíæ Save</button>
            <button class="btn btn-secondary" onclick="resetZoom()">üîç Reset</button>
            <button class="btn btn-warning" onclick="toggleHelp(true)">? Help</button>
            <button class="btn btn-dark" onclick="toggleTheme()">üåó Theme</button>
        </div>
        <div id="editorArea" class="editor-area">
            <p style="color:var(--text-muted); text-align:center; margin-top:50px;">
                Load a file or click "+ New Prog"<br>to start.<br><br>
                <small>Click <b>? Help</b> for instructions.</small>
            </p>
        </div>
    </div>

    <div class="main-content">
        <div class="chart-container">
            <canvas id="waveChart"></canvas>
        </div>
    </div>

    <div id="helpModal" class="modal-overlay" onclick="toggleHelp(false)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <span class="modal-close" onclick="toggleHelp(false)">&times;</span>
            <div class="help-section">
                <h3>üìå How to Use</h3>
                <ul>
                    <li><b>Load File:</b> Upload a Chroma CSV file (e.g., <code>*_W_mem.csv</code>).</li>
                    <li><b>New Program:</b> Click <span class="help-key">+ New Prog</span> to start from scratch.</li>
                    <li><b>Theme:</b> Click <span class="help-key">üåó Theme</span> to toggle Dark Mode.</li>
                </ul>

                <h3>‚ö° Parameters Explained</h3>
                <ul>
                    <li><span class="help-key">Volt (V)</span>: Target voltage for the step.</li>
                    <li><span class="help-key">Time (s)</span>: Duration of the step.</li>
                    <li><span class="help-key">Slew (V/ms)</span>: Speed of voltage change.</li>
                    <li><span class="help-key">Link Next (ID)</span>: ID of the NEXT Program (0 to stop).</li>
                    <li><span class="help-key">Loop Count</span>: Repeat count for this program.</li>
                </ul>
            </div>
        </div>
    </div>

<script>
    let myChart = null;
    let globalPrograms = {}; 

    // --- Theme Logic ---
    // Check LocalStorage for theme preference from index page
    const storedTheme = localStorage.getItem('theme');
    if (storedTheme === 'dark') {
        document.body.classList.add('dark-mode');
    }

    function toggleTheme() {
        document.body.classList.toggle('dark-mode');
        updateChartTheme();
        
        // Save preference
        let theme = 'light';
        if (document.body.classList.contains('dark-mode')) theme = 'dark';
        localStorage.setItem('theme', theme);
    }

    function updateChartTheme() {
        if (!myChart) return;
        const isDark = document.body.classList.contains('dark-mode');
        const gridColor = isDark ? '#444' : '#e5e5e5';
        const textColor = isDark ? '#aaa' : '#666';
        
        myChart.options.scales.x.grid.color = gridColor;
        myChart.options.scales.y.grid.color = gridColor;
        myChart.options.scales.x.ticks.color = textColor;
        myChart.options.scales.y.ticks.color = textColor;
        myChart.options.scales.x.title.color = textColor;
        myChart.options.scales.y.title.color = textColor;
        myChart.update();
    }

    // --- Modal Logic ---
    function toggleHelp(show) {
        document.getElementById('helpModal').style.display = show ? 'flex' : 'none';
    }

    // --- File Reading ---
    document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                globalPrograms = parseChromaFile(e.target.result);
                renderEditor();
                updateChart();
            } catch (err) { alert("Parsing Error: " + err.message); }
        };
        reader.readAsText(file);
    });

    // --- Core Editor Logic ---
    window.addNewProgram = function() {
        const ids = Object.keys(globalPrograms).map(Number);
        const newId = (ids.length > 0 ? Math.max(...ids) : 0) + 1;
        globalPrograms[newId] = { count: 1, link: 0, sequences: { 1: { volt: 0, time: 1, slew: 1, curr: 50, ttl: 0 } } };
        renderEditor();
        updateChart();
    };

    window.deleteProgram = function(pId) {
        if (!confirm(`Delete Program ${pId}?`)) return;
        delete globalPrograms[pId];
        renderEditor();
        updateChart();
    };

    window.addSequence = function(pId) {
        const prog = globalPrograms[pId];
        const seqIds = Object.keys(prog.sequences).map(Number);
        const newSeqId = (seqIds.length > 0 ? Math.max(...seqIds) : 0) + 1;
        const lastSeq = seqIds.length > 0 ? prog.sequences[seqIds[seqIds.length-1]] : { volt: 0, time: 1, slew: 1, curr: 50, ttl: 0 };
        prog.sequences[newSeqId] = { ...lastSeq }; 
        renderEditor();
        updateChart();
    };

    window.deleteSequence = function(pId, sId) {
        if (Object.keys(globalPrograms[pId].sequences).length <= 1) { alert("Must have at least one sequence."); return; }
        delete globalPrograms[pId].sequences[sId];
        renderEditor();
        updateChart();
    };

    // --- UI Rendering ---
    function renderEditor() {
        const container = document.getElementById('editorArea');
        container.innerHTML = '';
        const programs = globalPrograms;

        if (Object.keys(programs).length === 0) {
            container.innerHTML = '<p style="color:var(--text-muted); text-align:center; margin-top:50px;">No programs available.<br>Click "+ New Prog".</p>';
            return;
        }

        Object.keys(programs).map(Number).sort((a,b)=>a-b).forEach(pId => {
            const prog = programs[pId];
            const block = document.createElement('div');
            block.className = 'prog-block';

            block.innerHTML = `
                <div class="prog-header">
                    <span>Program ${pId}</span>
                    <button class="btn btn-danger btn-sm" onclick="deleteProgram(${pId})">Delete Prog</button>
                </div>
                <div class="prog-settings">
                    <div>
                        <label>Loop Count</label>
                        <input type="number" value="${prog.count}" min="1" onchange="updateProgData(${pId}, 'count', this.value)">
                    </div>
                    <div>
                        <label>Link Next (ID)</label>
                        <input type="number" value="${prog.link}" min="0" onchange="updateProgData(${pId}, 'link', this.value)">
                    </div>
                </div>
            `;

            const table = document.createElement('table');
            table.className = 'seq-table';
            table.innerHTML = `<thead><tr><th style="width:10%">#</th><th>Volt(V)</th><th>Time(s)</th><th>Slew</th><th style="width:10%"></th></tr></thead><tbody></tbody>`;
            
            const tbody = table.querySelector('tbody');
            const seqIds = Object.keys(prog.sequences).map(Number).sort((a,b) => a-b);
            
            seqIds.forEach(sId => {
                const seq = prog.sequences[sId];
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${sId}</td>
                    <td><input type="number" step="0.1" value="${seq.volt}" onchange="updateSeqData(${pId}, ${sId}, 'volt', this.value)"></td>
                    <td><input type="number" step="0.001" value="${seq.time}" onchange="updateSeqData(${pId}, ${sId}, 'time', this.value)"></td>
                    <td><input type="number" step="0.1" value="${seq.slew}" onchange="updateSeqData(${pId}, ${sId}, 'slew', this.value)"></td>
                    <td style="text-align:center;"><button class="btn btn-danger btn-sm" style="padding:0 5px;" onclick="deleteSequence(${pId}, ${sId})">√ó</button></td>
                `;
                tbody.appendChild(tr);
            });

            block.appendChild(table);
            block.insertAdjacentHTML('beforeend', `<div class="add-seq-row"><button class="btn btn-secondary btn-sm" onclick="addSequence(${pId})">+ Add Step</button></div>`);
            container.appendChild(block);
        });
    }

    // --- Data Handlers ---
    window.updateProgData = function(pId, field, val) { globalPrograms[pId][field] = parseFloat(val); updateChart(); };
    window.updateSeqData = function(pId, sId, field, val) { globalPrograms[pId].sequences[sId][field] = parseFloat(val); updateChart(); };

    // --- Parser ---
    function parseChromaFile(text) {
        const lines = text.split(/\r?\n/);
        const programs = {};
        let currentProg = null, currentSeq = null;

        lines.forEach(line => {
            line = line.trim().toUpperCase();
            if (!line) return;
            const parts = line.split(/\s+/), cmd = parts[0];

            if (cmd === 'PROG:SEL') {
                const pId = parseInt(parts[1]);
                if (!isNaN(pId)) { currentProg = pId; if (!programs[pId]) programs[pId] = { sequences: {}, link: 0, count: 1 }; }
            }
            else if (cmd === 'PROG:LINK' && currentProg) programs[currentProg].link = parseInt(parts[1]) || 0;
            else if (cmd === 'PROG:COUNT' && currentProg) programs[currentProg].count = parseInt(parts[1]) || 1;
            else if (cmd === 'PROG:SEQ:SEL' && currentProg) {
                currentSeq = parseInt(parts[1]);
                if (!programs[currentProg].sequences[currentSeq]) programs[currentProg].sequences[currentSeq] = { volt: 0, time: 0, slew: 0, curr: 50, ttl: 0 };
            }
            else if (currentProg && currentSeq) {
                const val = parseFloat(parts[1]);
                const seq = programs[currentProg].sequences[currentSeq];
                if (cmd === 'PROG:SEQ:VOLT') seq.volt = val;
                else if (cmd.includes('SLEW')) seq.slew = val;
                else if (cmd === 'PROG:SEQ:TIME') seq.time = val;
                else if (cmd === 'PROG:SEQ:CURR') seq.curr = val;
                else if (cmd === 'PROG:SEQ:TTL') seq.ttl = parseInt(val);
            }
        });
        return programs;
    }

    // --- Chart Logic ---
    function updateChart() {
        const isDark = document.body.classList.contains('dark-mode');
        const gridColor = isDark ? '#444' : '#e5e5e5';
        const textColor = isDark ? '#aaa' : '#666';

        const dataPoints = generateWaveform(globalPrograms);
        const ctx = document.getElementById('waveChart').getContext('2d');
        if (myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'line',
            data: { datasets: [{ label: 'Voltage', data: dataPoints, borderColor: '#007bff', borderWidth: 2, pointRadius: 0, fill: false, tension: 0 }] },
            options: {
                responsive: true, maintainAspectRatio: false, interaction: { intersect: false, mode: 'index' },
                scales: { 
                    x: { 
                        type: 'linear', 
                        title: { display: true, text: 'Time (s)', color: textColor },
                        grid: { color: gridColor },
                        ticks: { color: textColor }
                    }, 
                    y: { 
                        title: { display: true, text: 'Voltage (V)', color: textColor },
                        grid: { color: gridColor },
                        ticks: { color: textColor }
                    } 
                },
                plugins: {
                    tooltip: { callbacks: { title: ctx => `Time: ${ctx[0].parsed.x.toFixed(4)} s`, label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y.toFixed(2)} V` } },
                    zoom: { zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' }, pan: { enabled: true, mode: 'x' } }
                }
            }
        });
    }

    function generateWaveform(programs) {
        let points = [{x:0, y:0}], t=0, currentV=0, progId=1, safeGuard=0;
        if (!programs[progId]) { const keys = Object.keys(programs).map(Number).sort((a,b)=>a-b); if(keys.length>0) progId=keys[0]; else return points; }

        while (progId!==0 && programs[progId] && points.length<30000 && safeGuard<100) {
            const prog = programs[progId];
            const seqIds = Object.keys(prog.sequences).map(Number).sort((a,b)=>a-b);
            for (let loop=0; loop<prog.count; loop++) {
                if (points.length>=30000) break;
                for (const sId of seqIds) {
                    const seq = prog.sequences[sId], targetV = seq.volt, duration = seq.time, slew = seq.slew;
                    let rampTime = (slew > 0) ? (Math.abs(targetV - currentV) / slew) / 1000 : 0;
                    if (rampTime > 0 && rampTime < duration) {
                        t += rampTime; currentV = targetV; points.push({x: t, y: currentV});
                        t += (duration - rampTime); points.push({x: t, y: currentV});
                    } else if (rampTime >= duration) {
                        const dir = targetV > currentV ? 1 : -1;
                        currentV += (dir * slew * (duration * 1000));
                        t += duration; points.push({x: t, y: currentV});
                    } else {
                        currentV = targetV; points.push({x: t, y: currentV});
                        t += duration; points.push({x: t, y: currentV});
                    }
                }
            }
            progId = prog.link; safeGuard++;
        }
        return points;
    }

    window.resetZoom = function() { if(myChart) myChart.resetZoom(); }
    window.downloadCSV = function() {
        let csv = "CONF:REM ON\nSOUR:VOLT 0\nSOUR:CURR 50\nCONF:OUTP ON\nPROG:MODE LIST\n\n";
        Object.keys(globalPrograms).map(Number).sort((a,b)=>a-b).forEach(pId => {
            const prog = globalPrograms[pId];
            csv += `PROG:SEL ${pId}\nPROG:CLEAR\nPROG:SEL ${pId}\nPROG:COUNT ${prog.count}\nPROG:LINK ${prog.link}\n`;
            const seqIds = Object.keys(prog.sequences).map(Number).sort((a,b)=>a-b);
            csv += `PROG:ADD ${seqIds.length}\n\n`;
            seqIds.forEach(sId => {
                const seq = prog.sequences[sId];
                csv += `PROG:SEQ:SEL ${sId}\nPROG:SEQ:TYPE AUTO\nPROG:SEQ:VOLT ${seq.volt}\nPROG:SEQ:VOLT:SLEW ${seq.slew}\nPROG:SEQ:CURR ${seq.curr||50}\nPROG:SEQ:TTL ${seq.ttl||0}\nPROG:SEQ:TIME ${seq.time}\n\n`;
            });
        });
        csv += "CONF:REM OFF\n";
        const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'})); a.download = 'chroma_waveform.csv'; document.body.appendChild(a); a.click(); document.body.removeChild(a);
    };
</script>
</body>
</html>